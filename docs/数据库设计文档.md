# 数据库设计文档

## 概述

本文档描述了Swagger解析器项目的数据库表结构设计，包含5个核心表：服务器信息表、接口基础信息表、请求参数表、响应参数表、头部信息表。

## 数据库信息

- **数据库名**: swagger_parser
- **字符集**: utf8mb4
- **排序规则**: utf8mb4_unicode_ci
- **存储引擎**: InnoDB

## 表结构设计

### 1. server_info（服务器信息表）

存储Swagger文档中定义的服务器信息。

| 字段名 | 类型 | 长度 | 是否必填 | 说明 |
|--------|------|------|----------|------|
| id | BIGINT | - | 是 | 主键ID，自增 |
| server_url | VARCHAR | 500 | 是 | 服务器URL |
| description | VARCHAR | 500 | 否 | 服务器描述 |
| swagger_version | VARCHAR | 10 | 否 | Swagger文档版本（v2/v3） |
| create_time | DATETIME | - | 是 | 创建时间 |

**索引**:
- PRIMARY KEY (id)
- UNIQUE KEY uk_server_url (server_url)

**说明**:
- 服务器URL唯一，避免重复存储
- 一个Swagger文档可能包含多个服务器，每个服务器一条记录

---

### 2. api_info（接口基础信息表）

存储接口的基本信息，包括路径、方法、描述等。

| 字段名 | 类型 | 长度 | 是否必填 | 说明 |
|--------|------|------|----------|------|
| id | BIGINT | - | 是 | 主键ID，自增 |
| path | VARCHAR | 500 | 是 | 接口路径 |
| method | VARCHAR | 10 | 是 | 请求方法（GET/POST/PUT/DELETE等） |
| server_id | BIGINT | - | 否 | 服务器ID（关联server_info表） |
| server_url | VARCHAR | 500 | 否 | 服务器地址（冗余字段，便于查询） |
| description | TEXT | - | 否 | 接口描述 |
| tags | VARCHAR | 200 | 否 | 接口标签/分组（多个标签用逗号分隔） |
| operation_id | VARCHAR | 200 | 否 | 操作ID（OpenAPI中的operationId） |
| swagger_version | VARCHAR | 10 | 否 | Swagger文档版本（v2/v3） |
| create_time | DATETIME | - | 是 | 创建时间 |
| update_time | DATETIME | - | 否 | 更新时间 |

**索引**:
- PRIMARY KEY (id)
- INDEX idx_path_method (path, method) - 用于按路径和方法查询
- INDEX idx_server_id (server_id) - 用于按服务器查询

**说明**:
- 路径和方法组合唯一标识一个接口
- server_url为冗余字段，避免频繁关联查询
- 支持按路径、方法、标签等条件查询

---

### 3. request_param（请求参数表）

存储接口的请求参数，支持扁平化存储嵌套结构。

| 字段名 | 类型 | 长度 | 是否必填 | 说明 |
|--------|------|------|----------|------|
| id | BIGINT | - | 是 | 主键ID，自增 |
| api_id | BIGINT | - | 是 | 关联的接口ID（外键） |
| param_name | VARCHAR | 200 | 是 | 参数名称 |
| location | VARCHAR | 50 | 是 | 参数位置（path/header/query/form/body等） |
| param_type | VARCHAR | 50 | 是 | 数据类型（String/Number/Boolean/Array/Object等） |
| required | BOOLEAN | - | 是 | 是否必填（默认false） |
| pattern | VARCHAR | 500 | 否 | 正则表达式 |
| pattern_example | VARCHAR | 500 | 否 | 正则示例值（根据正则自动生成） |
| example | VARCHAR | 1000 | 否 | 自带示例值 |
| description | TEXT | - | 否 | 参数描述 |
| hierarchy_path | VARCHAR | 500 | 否 | 层级路径（用于扁平化，如：user.name、items[0].id） |
| parent_id | BIGINT | - | 否 | 父参数ID（用于构建层级关系） |

**索引**:
- PRIMARY KEY (id)
- INDEX idx_api_id (api_id) - 用于按接口查询参数
- INDEX idx_location (location) - 用于按位置筛选参数
- INDEX idx_param_type (param_type) - 用于按类型筛选参数
- FOREIGN KEY (api_id) REFERENCES api_info(id) ON DELETE CASCADE

**说明**:
- 支持扁平化存储嵌套对象和数组结构
- hierarchy_path字段保存完整的层级路径，如：`user.profile.name`、`items[0].id`
- parent_id用于构建父子关系，便于重建层级结构
- 如果参数包含正则表达式，自动生成pattern_example
- 级联删除：删除接口时自动删除关联的请求参数

**扁平化示例**:
```
原始结构：
{
  "user": {
    "name": "string",
    "age": "integer"
  },
  "items": [
    {"id": "integer"}
  ]
}

扁平化后：
- user.name (hierarchy_path: "user.name", parent_id: null)
- user.age (hierarchy_path: "user.age", parent_id: null)
- items[0].id (hierarchy_path: "items[0].id", parent_id: null)
```

---

### 4. response_param（响应参数表）

存储接口的响应参数，按状态码分类，支持扁平化存储嵌套结构。

| 字段名 | 类型 | 长度 | 是否必填 | 说明 |
|--------|------|------|----------|------|
| id | BIGINT | - | 是 | 主键ID，自增 |
| api_id | BIGINT | - | 是 | 关联的接口ID（外键） |
| status_code | VARCHAR | 10 | 是 | HTTP状态码（200/400/500等） |
| param_name | VARCHAR | 200 | 是 | 参数名称 |
| param_type | VARCHAR | 50 | 是 | 数据类型（String/Number/Boolean/Array/Object等） |
| example | VARCHAR | 1000 | 否 | 示例值 |
| description | TEXT | - | 否 | 参数描述 |
| hierarchy_path | VARCHAR | 500 | 否 | 层级路径（用于扁平化，如：data.user.name、items[0].id） |
| parent_id | BIGINT | - | 否 | 父参数ID（用于构建层级关系） |

**索引**:
- PRIMARY KEY (id)
- INDEX idx_api_id (api_id) - 用于按接口查询参数
- INDEX idx_status_code (status_code) - 用于按状态码筛选参数
- FOREIGN KEY (api_id) REFERENCES api_info(id) ON DELETE CASCADE

**说明**:
- 每个状态码的响应体参数单独存储
- 支持扁平化存储嵌套结构，机制同request_param
- 级联删除：删除接口时自动删除关联的响应参数

---

### 5. header_info（头部信息表）

存储接口的请求头和响应头信息。

| 字段名 | 类型 | 长度 | 是否必填 | 说明 |
|--------|------|------|----------|------|
| id | BIGINT | - | 是 | 主键ID，自增 |
| api_id | BIGINT | - | 是 | 关联的接口ID（外键） |
| header_type | VARCHAR | 20 | 是 | 头部类型（REQUEST/RESPONSE） |
| header_name | VARCHAR | 200 | 是 | 头部名称 |
| data_type | VARCHAR | 50 | 否 | 数据类型（String/Number/Boolean等） |
| required | BOOLEAN | - | 是 | 是否必填（默认false） |
| example | VARCHAR | 500 | 否 | 示例值 |
| description | TEXT | - | 否 | 描述 |

**索引**:
- PRIMARY KEY (id)
- INDEX idx_api_id (api_id) - 用于按接口查询头部信息
- INDEX idx_header_type (header_type) - 用于按类型筛选（请求头/响应头）
- FOREIGN KEY (api_id) REFERENCES api_info(id) ON DELETE CASCADE

**说明**:
- header_type区分请求头和响应头
- 级联删除：删除接口时自动删除关联的头部信息

---

## 表关系图

```
server_info (1) ──────< (N) api_info (1) ──────< (N) request_param
                                              │
                                              ├───< (N) response_param
                                              │
                                              └───< (N) header_info
```

**关系说明**:
- 一个服务器可以有多个接口（server_info 1:N api_info）
- 一个接口可以有多个请求参数（api_info 1:N request_param）
- 一个接口可以有多个响应参数（api_info 1:N response_param）
- 一个接口可以有多个头部信息（api_info 1:N header_info）

## 设计原则

1. **扁平化设计**: 将嵌套的JSON结构扁平化存储，便于查询和展示
2. **层级关系保留**: 通过hierarchy_path和parent_id保留原始层级关系
3. **冗余字段**: server_url在api_info中冗余存储，提高查询性能
4. **级联删除**: 使用外键级联删除，保证数据一致性
5. **索引优化**: 为常用查询字段建立索引，提高查询性能

## 数据示例

### api_info示例
```sql
INSERT INTO api_info (path, method, server_url, description, tags, swagger_version) 
VALUES ('/api/users', 'GET', 'http://localhost:8080', '获取用户列表', '用户管理', 'v3');
```

### request_param示例
```sql
INSERT INTO request_param (api_id, param_name, location, param_type, required, hierarchy_path) 
VALUES (1, 'page', 'query', 'Integer', false, 'page');
```

### response_param示例
```sql
INSERT INTO response_param (api_id, status_code, param_name, param_type, hierarchy_path) 
VALUES (1, '200', 'data', 'Array', 'data');
```

## 性能优化建议

1. **分页查询**: 接口列表查询使用分页，避免一次性加载大量数据
2. **索引使用**: 充分利用已建立的索引进行查询
3. **批量操作**: 导入Swagger文档时使用批量插入，提高性能
4. **缓存策略**: 对于频繁查询的接口信息，可以考虑使用Redis缓存

## 扩展性考虑

1. **版本管理**: 未来可以增加版本字段，支持同一接口的多个版本
2. **历史记录**: 可以增加历史记录表，记录接口变更历史
3. **权限控制**: 可以增加用户表和权限表，实现多租户和权限控制

